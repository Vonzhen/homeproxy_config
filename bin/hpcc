#!/bin/sh
# --- [ HPCC: 维斯特洛领主议事厅 - 控制面板 ] ---
source /etc/hpcc/env.conf

show_menu() {
    clear
    TICK=$(cat /etc/hpcc/last_tick 2>/dev/null || echo "0")
    echo -e "\033[36m======================================\033[0m"
    echo -e "   \033[1m战略要塞：\033[33m【$LOCATION】\033[0m"
    echo -e "   \033[1m当前密令 (Tick)：\033[32m$TICK\033[0m"
    echo -e "\033[36m======================================\033[0m"
    echo -e "  1) ⚔️ \033[32m全军列阵\033[0m (立即强制同步配置)"
    echo -e "  2) 🛡️ \033[31m退守要塞\033[0m (紧急回滚至旧配置)"
    echo -e "  3) 📜 \033[33m守夜人誓言\033[0m (查看战区运行状态)"
    echo -e "  4) ⚙️  \033[35m领主密令\033[0m (查看当前环境设置)"
    echo -e "--------------------------------------"
    echo -e "  u) 🆙 征召新兵 (从 GitHub 更新脚本)"
    echo -e "  x) 🗑️  废弃堡垒 (完全卸载 HPCC)"
    echo -e "  q) 暂时离职"
    echo -e "\033[36m======================================\033[0m"
    printf "领主大人，请指示 [1-q]: "
}

while true; do
    show_menu
    read choice
    case $choice in
        1)
            echo -e "\n\033[32m[指令]\033[0m 正在重新锻造积木城墙..."
            sh /etc/hpcc/bin/hp_download && sh /etc/hpcc/bin/hp_config_update
            echo -e "\n锻造完成，回车返回议事厅..."; read ;;
        2)
            echo -e "\n\033[31m[紧急]\033[0m 正在执行战略后撤..."
            sh /etc/hpcc/bin/hp_rollback
            echo -e "\n已退回旧部，回车返回议事厅..."; read ;;
        3)
            echo -e "\n\033[33m[简报]\033[0m"
            echo "--------------------------------------"
            echo "最近截获 Tick: $TICK"
            echo "配置最近熔炼: $(ls -l /etc/config/homeproxy | awk '{print $6,$7,$8}')"
            echo "堡垒地基路径: /etc/hpcc"
            echo "--------------------------------------"
            echo "阅读完毕，回车返回..."; read ;;
        4)
            echo -e "\n\033[35m[情报]\033[0m"
            cat /etc/hpcc/env.conf
            echo -e "\n阅后即焚，回车返回..."; read ;;
        u)
            echo -e "\n\033[36m[征召]\033[0m 正在向 $GH_USER 家族请求支援..."
            wget -qO /tmp/i.sh "$GH_RAW_URL/install.sh" && sh /tmp/i.sh
            echo "援军已至，回车返回..."; read ;;
        x)
            printf "\n⚠️  确定要撤回所有守军并废弃堡垒吗？[y/N]: "
            read confirm
            if [ "$confirm" = "y" ]; then
                (crontab -l | grep -v "hpcc") | crontab -
                rm -rf /etc/hpcc /usr/bin/hpcc
                echo "堡垒已成废墟。北境永不遗忘！"
                exit 0
            fi ;;
        q) exit 0 ;;
        *) echo "无效指令，领主大人"; sleep 1 ;;
    esac
done
